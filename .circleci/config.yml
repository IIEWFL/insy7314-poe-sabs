version: 2.1

orbs:
  sonarcloud: sonarsource/sonarcloud@2.0.0

jobs:
  build-and-test:
    docker:
      - image: cimg/node:18.0
    working_directory: ~/repo
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "package-lock.json" }}
            - v1-dependencies-
      - restore_cache:
          keys:
            - v1-server-dependencies-{{ checksum "server/package-lock.json" }}
            - v1-server-dependencies-
      - run:
          name: Install Dependencies
          command: |
            npm ci
            cd server && npm ci
      - save_cache:
          paths:
            - node_modules
            - server/node_modules
          key: v1-dependencies-{{ checksum "package-lock.json" }}
      - run:
          name: Build Application
          command: |
            npm run build
            cd server && npm run build
      - run:
          name: Run Frontend Tests with Coverage
          command: |
            npm test -- --coverage || true
      - run:
          name: Run Backend Tests with Coverage
          command: |
            cd server && npm run test:coverage || true
      - run:
          name: Prepare Coverage Reports
          command: |
            mkdir -p coverage
            # Ensure coverage files exist for SonarQube
            if [ -f coverage/lcov.info ]; then
              echo "Frontend coverage found"
            fi
            # Copy backend coverage if exists
            if [ -f server/coverage/lcov.info ]; then
              cp server/coverage/lcov.info coverage/backend-lcov.info || true
            fi
      - store_test_results:
          path: coverage
      - store_artifacts:
          path: coverage
          destination: test-results

  sonarcloud-scan:
    docker:
      - image: cimg/node:18.0
    working_directory: ~/repo
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "package-lock.json" }}
            - v1-dependencies-
      - restore_cache:
          keys:
            - v1-server-dependencies-{{ checksum "server/package-lock.json" }}
            - v1-server-dependencies-
      - run:
          name: Install Dependencies
          command: |
            npm ci
            cd server && npm ci
      - run:
          name: Run Tests with Coverage
          command: |
            npm test -- --coverage || true
            cd server && npm run test:coverage || true
      - run:
          name: Prepare Coverage Reports
          command: |
            mkdir -p coverage
            # Ensure coverage files exist
            if [ -f server/coverage/lcov.info ]; then
              cp server/coverage/lcov.info coverage/backend-lcov.info || true
            fi
      - sonarcloud/scan

  security-scan:
    docker:
      - image: cimg/node:18.0
    working_directory: ~/repo
    steps:
      - checkout
      - run:
          name: Install Dependencies
          command: |
            npm ci
            cd server && npm ci
      - run:
          name: Security Audit
          command: |
            npm audit --audit-level=moderate || true
            cd server && npm audit --audit-level=moderate || true
      - run:
          name: Lint Security Issues
          command: |
            npm run lint || true
            cd server && npx tsc --noEmit || true
      - store_artifacts:
          path: npm-audit-results
          destination: security-reports

workflows:
  main:
    jobs:
      - build-and-test
      - sonarcloud-scan:
          requires:
            - build-and-test
          context: SonarCloud
          filters:
            branches:
              only: main
      - security-scan

